name: Auto PR

on:
  push:
    branches:
      - dev
      - 'feature/**'
      - 'fix/**'
      - 'refactor/**'
      - 'docs/**'
      - 'chore/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine PR settings
        id: pr-config
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # Helper to convert branch name to title (kebab-case to sentence)
          to_title() {
            echo "$1" | sed 's/-/ /g'
          }

          if [ "$BRANCH" = "dev" ]; then
            echo "base=master" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "title=chore: release" >> $GITHUB_OUTPUT
          else
            echo "base=dev" >> $GITHUB_OUTPUT
            echo "draft=true" >> $GITHUB_OUTPUT

            # Generate conventional commit style title based on branch prefix
            case "$BRANCH" in
              feature/*)
                NAME=$(to_title "${BRANCH#feature/}")
                echo "title=feat: $NAME" >> $GITHUB_OUTPUT
                ;;
              fix/*)
                NAME=$(to_title "${BRANCH#fix/}")
                echo "title=fix: $NAME" >> $GITHUB_OUTPUT
                ;;
              refactor/*)
                NAME=$(to_title "${BRANCH#refactor/}")
                echo "title=refactor: $NAME" >> $GITHUB_OUTPUT
                ;;
              docs/*)
                NAME=$(to_title "${BRANCH#docs/}")
                echo "title=docs: $NAME" >> $GITHUB_OUTPUT
                ;;
              chore/*)
                NAME=$(to_title "${BRANCH#chore/}")
                echo "title=chore: $NAME" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "title=chore: $BRANCH" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Generate PR title and body
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BASE_BRANCH: ${{ steps.pr-config.outputs.base }}
          FALLBACK_TITLE: ${{ steps.pr-config.outputs.title }}
        run: |
          chmod +x .github/scripts/collect-changes.sh .github/scripts/generate-pr-body.sh
          .github/scripts/collect-changes.sh "$BASE_BRANCH" > /tmp/changes.txt
          .github/scripts/generate-pr-body.sh /tmp/changes.txt "$FALLBACK_TITLE" "both" > /tmp/output.txt

          # Parse title and body from output
          TITLE=$(grep "^TITLE:" /tmp/output.txt | sed 's/^TITLE://')
          sed -n '/^BODY_START$/,$ p' /tmp/output.txt | tail -n +2 > /tmp/body.md

          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING=$(gh pr list --head "${{ steps.pr-config.outputs.branch }}" --base "${{ steps.pr-config.outputs.base }}" --json number --jq '.[0].number // empty')
          echo "existing=$EXISTING" >> $GITHUB_OUTPUT

      - name: Create or update PR
        env:
          GH_TOKEN: ${{ github.token }}
          PR_TITLE: ${{ steps.generate.outputs.title }}
        run: |
          if [ -n "${{ steps.check-pr.outputs.existing }}" ]; then
            echo "PR #${{ steps.check-pr.outputs.existing }} already exists, updating..."
            gh pr edit "${{ steps.check-pr.outputs.existing }}" \
              --title "$PR_TITLE" \
              --body-file /tmp/body.md
          else
            DRAFT_FLAG=""
            if [ "${{ steps.pr-config.outputs.draft }}" = "true" ]; then
              DRAFT_FLAG="--draft"
            fi

            gh pr create \
              --base "${{ steps.pr-config.outputs.base }}" \
              --head "${{ steps.pr-config.outputs.branch }}" \
              --title "$PR_TITLE" \
              --body-file /tmp/body.md \
              $DRAFT_FLAG
          fi
